A = array(double, [13, 13])
u = array(double, [13, 13, 13])
D = array(double, [13, 13, 13])

Dt = transpose(D, [[1, 3]])

At = vtranspose(A, [[1, 2]])
tmp1 = contract(At, u, [[2, 1]])
tmp2 = contract(At, tmp1, [[2, 2]])
tmp2t = vtranspose(tmp2, [[1, 2]])
tmp3 = contract(At, tmp2t, [[2, 3]])
tmp3t = vtranspose(tmp3, [[1, 3]])
tmp4 = entrywise_mul(Dt, tmp3t)
tmp4t = vtranspose(tmp4, [[1, 3]])
tmp5 = contract(A, tmp4t, [[2, 1]])
tmp5t = vtranspose(tmp5, [[2, 3]]) 
tmp6 = contract(A, tmp5t, [[2, 2]])
v = contract(A, tmp6, [[2, 3]])

ld = build(Dt)
l1 = build(tmp1)
l2 = build(tmp2)
l3 = build(tmp3)
l4 = build(tmp4)
l5 = build(tmp5)
l6 = build(tmp6)
lv = build(v)

l1a = interchange(l1, [[4, 3]])
l1b = interchange(l1a, [[4, 2]])
l2a = interchange(l2, [[2, 1]])
l2b = interchange(l2a, [[1, 4]])
l3a = interchange(l3, [[3, 2]])
l3b = interchange(l3a, [[1, 3]])
l3c = interchange(l3b, [[1, 2]])
l3d = interchange(l3c, [[1, 4]])
l4a = interchange(l4, [[3, 1]])
l5a = interchange(l5, [[3, 2]])  

init(A, 1)
init(D, 1)
init(u, 1)
init(tmp1, 0)
init(tmp2, 0)
init(tmp3, 0)
init(tmp4, 0)
init(tmp5, 0)
init(tmp6, 0)
init(Dt, 1)
init(v, 0)
codegen([ld, l1, l2, l3, l4, l5, l6, lv])
codegen([ld, l1b, l2b, l3d, l4a, l5a, l6, lv])
