A = array(2, double, [N, N])
u = array(3, double, [N, N, N])
D = array(3, double, [N, N, N])
At = vtranspose(A, 1, 2)
tmp2t = vtranspose(tmp2, 1, 2)
tmp3t = vtranspose(tmp3, 1, 3)
tmp4t = vtranspose(tmp4, 1, 3)
tmp5t = vtranspose(tmp5, 2, 3)
tmp1 = contract(At, u, [2, 1])
tmp2 = contract(At, tmp1, [2, 2])
tmp3 = contract(At, tmp2t, [2, 3])
tmp4 = entrywise(D, tmp3t)
tmp5 = contract(A, tmp4t, [2, 1])
tmp6 = contract(A, tmp5t, [2, 2])
v = contract(A, tmp6, [2, 3])
  Dt = transpose(D, 1, 3)

ld = build(Dt)
l1 = build(tmp1)
l2 = build(tmp2)
l3 = build(tmp3)
l4 = build(tmp4)
l5 = build(tmp5)
l6 = build(tmp6)
lv = build(v)

l1a = interchange(l1, [4, 3])
l1b = interchange(l1a, [4, 2])
l2a = interchange(l2, [2, 1])
l2b = interchange(l2a, [1, 4])
l3a = interchange(l3, [3, 2])
l3b = interchange(l3a, [1, 3])
l3c = interchange(l3b, [1, 2])
l3d = interchange(l3c, [1, 4])
l4a = interchange(l4, [3, 1])
l5a = interchange(l5, [3, 2])  