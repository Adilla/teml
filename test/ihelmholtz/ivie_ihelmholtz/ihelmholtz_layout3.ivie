A = array(2, double, [N, N])
u = array(3, double, [N, N, N])
D = array(3, double, [N, N, N])
At = vtranspose(A, 1, 2)
tmp1 = contract(At, u, [2, 1])
tmp2 = contract(At, tmp1, [2, 2])
tmp3 = contract(At, tmp2, [2, 3])
tmp4 = entrywise(D, tmp3)
tmp5 = contract(A, tmp4, [2, 1])
tmp6 = contract(A, tmp5, [2, 2])
v = contract(A, tmp6, [2, 3])

Dt = transpose(D, 1, 3)

i1 = iterator(0, N, 1)
i2 = iterator(0, N, 1)
i3 = iterator(0, N, 1)
i4 = iterator(0, N, 1)
j1 = iterator(0, N, 1)
j2 = iterator(0, N, 1)
j3 = iterator(0, N, 1)
j4 = iterator(0, N, 1)
k1 = iterator(0, N, 1)
k2 = iterator(0, N, 1)
k3 = iterator(0, N, 1)
k4 = iterator(0, N, 1)
l1 = iterator(0, N, 1)
l2 = iterator(0, N, 1)
l3 = iterator(0, N, 1)
i12 = iterator(0, N, 1)
i22 = iterator(0, N, 1)
i32 = iterator(0, N, 1)
i42 = iterator(0, N, 1)
j12 = iterator(0, N, 1)
j22 = iterator(0, N, 1)
j32 = iterator(0, N, 1)
j42 = iterator(0, N, 1)
k12 = iterator(0, N, 1)
k22 = iterator(0, N, 1)
k32 = iterator(0, N, 1)
k42 = iterator(0, N, 1)
td1 = iterator(0, N, 1)
td2 = iterator(0, N, 2)
td3 = iterator(0, N, 2)

build(tmp1, [i1, i2, i3, i4])
build(tmp2, [j1, j2, j3, j4])
build(tmp3, [k1, k2, k3, k4])
build(Dt, [td1, td2, td3])
build(tmp4, [l1, l2, l3])
build(tmp5, [i12, i22, i32, i42])
build(tmp6, [j12, j22, j32, j42])
build(v, [k12, k22, k32, k42])

parallelize(i1, THRD, None, [i2, i3, i4])
parallelize(j1, THRD, None, [j2, j3, j4])
parallelize(k1, THRD, None, [k2, k3, k4])
parallelize(i4, VEC, None, None)
parallelize(j4, VEC, None, None)
parallelize(k4, VEC, None, None)

parallelize(l1, THRD, None, [l2, l3])
parallelize(i12, THRD, None, [i22, i32, i42])
parallelize(j12, THRD, None, [j22, j32, j42])
parallelize(k12, THRD, None, [k22, k32, k42])
parallelize(i42, VEC, None, None)
parallelize(j42, VEC, None, None)
parallelize(k42, VEC, None, None)

interchange(i4, i3)
interchange(i4, i2)
interchange(i4, i1)
interchange(j3, j4)
interchange(j1, j2)
interchange(j1, j4)

tmp2t = vtranspose(tmp2, 1, 2)
replace_array(j3, tmp2, tmp2t)
replace_array(k4, tmp2, tmp2t)
interchange(k2, k3)
interchange(k1, k3)
interchange(k1, k2)
interchange(k1, k4)


tmp3t = vtranspose(tmp3, 1, 3)
replace_array(k1, tmp3, tmp3t)
replace_array(l3, tmp3, tmp3t)

tmp4t = vtranspose(tmp4, 1, 3)
replace_array(l3, tmp4, tmp4t)
replace_array(i42, tmp4, tmp4t)

tmp5t = vtranspose(tmp5, 1, 3)
replace_array(i42, tmp5, tmp5t)
replace_array(j42, tmp5, tmp5t)

tmp6t = vtranspose(tmp6, 2, 3)
tmp6tt = vtranspose(tmp6t, 1, 2)
replace_array(j42, tmp6, tmp6tt)
replace_array(k42, tmp6, tmp6tt)

Dtt = vtranspose(Dt, 1, 3)
replace_array(l3, D, Dtt)

interchange(l1, l3)
interchange(k32, k42)
interchange(k42, k22)
interchange(j22, j12)
interchange(j32, j22)
interchange(j22, j42)
interchange(i12, i32)